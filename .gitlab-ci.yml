# # Official language image. Look for the different tagged releases at:
# # https://hub.docker.com/r/library/python/tags/
# # Une fois deployé, gitlab se place dans le projet :
# /builds/desr-sires-pga/support_n1/Outils
# https://sonar.meteo.fr/tutorials?id=outils

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  ### BN 2025-07-18 invalidation configuration du proxy MF pour éviter pb ssl
  #http_proxy: "http://proxy.meteo.fr:11011"
  #https_proxy: "http://proxy.meteo.fr:11011"
  #no_proxy: "http://127.0.0.1,http://localhost"

  #$CI_COMMIT_REF_SLUG = master
  PACKAGE_NAME: ${CI_PROJECT_NAME}
  VERSION: "1.4.2"
  CI_DEBUG_TRACE: "false" # activation mode debug  => true
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

default:
  image: "python:3.12-slim"
  cache:
    - key: cache-$CI_COMMIT_REF_SLUG
      paths:
        - .cache/pip
        - .pyenv
        - envdev
        - public
      policy: pull-push
  artifacts:
    paths:
      - public

workflow:
  name: $PIPELINE_NAME
  rules:
    - if: $CI_PROJECT_URL =~ "https://git.meteo.fr/enm_test/requete_fin_mois"
      when: never
    - if: $CI_PROJECT_URL =~ "https://gitlab.meteo.fr/desr-sires-pga/support_n1/outils.git"
      when: always

# https://docs.gitlab.com/ee/ci/yaml/yaml_optimization.html
.some-actions-apt-before: &some-actions-apt-before
  # Pour éviter ultérieurement  : debconf: (Can't locate Term/ReadLine.pm ....
  - echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections
  - apt-get update || true
  - apt-get upgrade -y || true
  # Pour doxygen : https://askubuntu.com/questions/1291874/how-to-install-doxygen-on-ubuntu
  - apt-get install -y doxygen libxapian30 graphviz dia
  # Pour  shellcheck :
  - apt-get install -y shellcheck
  # Pour pylint :
  - apt-get install -y ca-certificates git curl python3-gitlab
  - glab auth login --job-token $CI_JOB_TOKEN --hostname $CI_SERVER_FQDN --api-protocol $CI_SERVER_PROTOCOL
  - glab -R $CI_PROJECT_PATH securefile download $SECURE_FILE_ID --path="/etc/ssl/certs/proxy1.crt"

  - export CURL_CA_BUNDLE="/etc/ssl/certs/proxy1.crt"
  - update-ca-certificates -f
  # - apt-get install -y rhino lcov
  #     build-essential zlib1g-dev libffi-dev tk-dev|| true
  # - apt-get install -y libbz2-dev libreadline-dev libsqlite3-dev libncurses-dev
  #     libssl-dev liblzma-dev python3-sphinx make || true
  # - apt-get install -y  python3-sphinx-copybutton sphinx-common
  #     python3-pydata-sphinx-theme python3-alabaster || true
.some_mise_en_forme_before: &some_mise_en_forme_before
  - export NORMALIZED_NAME=$(echo "${CI_PROJECT_NAME}" | tr '-' '_') || true
  - export TXT_RED="\e[31m" && TXT_CLEAR="\e[0m"
  - export TXT_YELLOW="\e[33m"
  - cd "$CI_PROJECT_DIR"
  - mkdir public || true

.gestion_env_python_before: &gestion_env_python_before
  - echo -e "${TXT_RED}Gestion env. virtuel python = envdev${TXT_CLEAR}"
  - python3 -m venv envdev || true
  - source envdev/bin/activate || true
  - echo -e "${TXT_RED}Gestion configuration git et curl et proxy ${TXT_CLEAR}"
  - git config --global http.sslVerify false
  - git config --global https.sslVerify false
  - git config --global https.proxy http://proxy.meteo.fr:11011
  - set GIT_SSL_NO_VERIFY
  - echo "proxy = http://proxy.meteo.fr:11011" > $HOME/.curlrc
  - echo "insecure" >> $HOME/.curlrc
  - echo "cacert=/etc/ssl/certs/ca-certificates.crt" >> $HOME/.curlrc

.gestion_pyenv: &gestion_pyenv
  - echo -e "${TXT_RED}Gestion pyenv${TXT_CLEAR}"
    # - curl -kfsSL https://pyenv.run | bash || true
  - curl -k -s -S -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash || true
  - export PYENV_ROOT="$HOME/.pyenv"
  - export PATH="$PYENV_ROOT/bin:$PATH"
  - eval "$(pyenv init - bash)" || true
  ### docker MF mode installation indirect
  - mkdir -p ~/.pyenv/cache/ || true
  - curl -k --output-dir ~/.pyenv/cache/ -o Python-3.10.19.tar.xz
      https://www.python.org/ftp/python/3.10.19/Python-3.10.19.tar.xz
  - curl -k --output-dir ~/.pyenv/cache/ -o Python-3.11.14.tar.xz
      https://www.python.org/ftp/python/3.11.14/Python-3.11.14.tar.xz || true
  - curl -k --output-dir ~/.pyenv/cache/ -o Python-3.12.12.tar.xz
      https://www.python.org/ftp/python/3.12.12/Python-3.12.12.tar.xz
  - pyenv install 3.10.19 || true
  - pyenv install 3.11.14 || true
  - pyenv install 3.12.12 || true
  - pyenv global 3.10 3.11 3.12

.gestion_pip_nexus: &gestion_pip_nexus

  - echo -e "${TXT_RED}Gestion pip nexus-sidev${TXT_CLEAR}"
  - pip config set global.trusted-host nexus-sidev.meteo.fr || true
  - pip config set global.index http://nexus-sidev.meteo.fr/repository/pypi-group/pypi || true
  - pip config set global.index-url http://nexus-sidev.meteo.fr/repository/pypi-group/simple || true

.gestion_pip_update: &gestion_pip_update
  - python3 -m pip install --upgrade pip
  - python3 -m pip install pylint-common --use-pep517
  - pip install -r docs/requirements.txt --root-user-action=ignore || true
  - pip install --upgrade pip --break-system-packages --root-user-action=ignore || true

before_script:
  # Normalize package name once at the start of any job

  # Use Météo-France's own PyPI-like registry, more info at
  # http://confluence.meteo.fr/display/MOT/Nexus+-+Guide+d%27utilisation#NexusGuided'utilisation-D%C3%A9p%C3%B4tpython

  - *some-actions-apt-before
  - *some_mise_en_forme_before
  - *gestion_env_python_before
  - *gestion_pyenv
  - *gestion_pip_nexus
  - *gestion_pip_update

#https://misc.flogisoft.com/bash/tip_colors_and_formatting


# composant sonarqube et analyse sécurité
# https://gitlab.meteo.fr/explore/catalog/ci-cd-catalog-mf/sca
#

# include:
#   - component: $CI_SERVER_FQDN/ci-cd-catalog-mf/sonar-scan/sonar-scan@1.0.2
#     inputs:
#       sonar-project-key : "requete_fin_mois"
#       sonar-project-version : ${VERSION}
#       sonar-token : ${SONAR_TOKEN}
#       sonar-host: ${SONAR_HOST_URL}
#       sonar-source: "src"
#       sonar-projectBaseDir: "."
#       allow_failure: true
#   - component: $CI_SERVER_FQDN/ci-cd-catalog-mf/sca/check-dependencies@1.0.3
#     inputs:
#       failOnSeverity : "MEDIUM"
#       allow_failure: true
#       source: "src"

stages:
  - lint
  # - test
  # - quality
  #- sca
  #- build
  - deploy

# Retry a job automatically if it fails (2 times)
.retry:
  retry: 2

job:Lint:
  stage: lint
  #image: "python:3.12-slim"
  cache:
    - key: cache-$CI_COMMIT_REF_SLUG
     # override the policy
      policy: pull
  script:
    - echo -e "${TXT_RED}script lint${TXT_CLEAR}"
    - rm -rf public/* || true
    - devtools/lanceur_shellcheck.bash || true
    - devtools/lanceur_pylint.bash || true
    # - devtools/lanceur_ruff.bash || true
    # - devtools/lanceur_tox.bash || true
    

    # - echo -e "${TXT_RED}Gestion rapports linters${TXT_CLEAR}"
    # - ls -ail rapports/*
    # #- mv rapports/coverage* public/ || true

    - echo -e "${TXT_RED}Documentations${TXT_CLEAR}"
    - devtools/lanceur_mefversions.bash $CI_COMMIT_SHORT_SHA $CI_PIPELINE_ID
    - devtools/lanceur_doxygen.bash || true
    #- devtools/lanceur_sphinx.bash || true

    - ls -ail rapports/*

    - mv rapports/*txt public/ || true
    # - mv rapports/*xml public/ || true
    # - mv rapports/tox_cov_html public/ || true
    - mv rapports/doxygen public/ || true
    #- mv build/sphinx-* public/ || true
      ### index de gitlab-pages :
    - cp -f docs/index.html public/ || true
    - cp -f docs/Outils.png public/ || true
    - ls -ail public/*

  artifacts:
    paths:
      - public

# job:Tests:
#   stage: test
#   image: "python:$VERSION-slim"
#   cache:
#     - key: cache-$CI_COMMIT_REF_SLUG
#      # override the policy
#       policy: pull
#   script:
#     - echo -e "${TXT_RED}script test${TXT_CLEAR}"
#     - echo -e "${TXT_YELLOW}Stage test en version = ${VERSION}${TXT_CLEAR}" || true
#     # - pip install -r docs/requirements.txt --root-user-action=ignore || true
#     - devtools/lanceur_pytest.bash "${VERSION}" || true
#     - ls -ail rapports/*
#     - mv -f rapports/htmlcov public/ || true
#     - mv rapports/coverage* public/ || true
#     - mv rapports/*txt public/  || true
#   parallel:
#     matrix:
#       # https://docs.gitlab.com/ee/ci/yaml/#parallelmatrix
#       - VERSION: ["3.10", "3.11", "3.12"]
#   artifacts:
#     paths:
#       - public

# job:Sonar:
#   stage: quality
#   #image: python:3.12-slim
#   cache:
#     policy: pull
#     key: cache-$CI_COMMIT_REF_SLUG
#     paths:
#       - "${SONAR_USER_HOME}/cache"
#       - public/
#   script:
#     - echo -e "${TXT_RED}script sonar${TXT_CLEAR}"
#     # - pip install -r docs/requirements.txt --root-user-action=ignore || true
#     - devtools/lanceur_pysonar.bash || true
#     - mv -f rapports/*txt public/ || true
#   allow_failure: true
#   rules:
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#     - if: $CI_COMMIT_BRANCH == 'main'
#   artifacts:
#     paths:
#       - public

# job:CheckDependencies:
#   stage: sca
#   cache:
#     policy: pull
#     key: cache-$CI_COMMIT_REF_SLUG
#     paths:
#       - public/
#   before_script:
#     - cd "$CI_PROJECT_DIR"
#   script:
#     - echo -e "${TXT_RED}script sca${TXT_CLEAR}"
#   allow_failure: true
#   rules:
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#     - if: $CI_COMMIT_BRANCH == 'main'
#   artifacts:
#     paths:
#       - public

# job:Packaging:
#   stage: build
#   #image: "python:3.12-slim"
#   cache:
#     policy: pull
#     key: cache-$CI_COMMIT_REF_SLUG
#     paths:
#       - public/
#   before_script:
#     - cd "$CI_PROJECT_DIR"
#     - *gestion_env_python_before
#     - *gestion_pip_nexus
#     - *gestion_pip_update
#   script:
#     - echo -e "${TXT_RED}script build${TXT_CLEAR}"
#     # - pip install -r docs/requirements.txt --root-user-action=ignore || true
#     - devtools/lanceur_build.bash || true
#     - ls -ail *
#     - mv rapports/*txt public/ || true
#     - ls -ail build/* || true
#   artifacts:
#     paths:
#       - public
#       - build/dist
#   only:
#     - main

job:Deploy:
  stage: deploy
  #image: python:3.12-slim
  cache:
    - key: cache-$CI_COMMIT_REF_SLUG
     # override the policy
      policy: pull
  before_script:
    - cd "$CI_PROJECT_DIR"
  script:
    - echo -e "${TXT_RED}script deploy${TXT_CLEAR}"
  after_script:
    - echo -e "${TXT_RED}after_script deploy${TXT_CLEAR}"
  artifacts:
    paths:
      - public
  pages: true # specifies that this is a Pages job
  only:
    - main
name: Doc_Quality_Gate_Steps
# Workflow en plusieurs étapes séquentielles pour déployer du contenu dynamique
# vers GitHub Pages et résultats pour sonar

#Documentations et refs:
#https://docs.github.com/fr/actions/using-workflows/workflow-syntax-for-github-actions
#https://www.githubstatus.com/
#https://github.com/charliermarsh/ruff
#https://github.com/bruschin/listem3u/new/main?filename=.github%2Fworkflows%2Fstatic.yml
#https://docs.github.com/fr/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests
#https://help.github.com/pages/
#https://docs.github.com/fr/actions/learn-github-actions/understanding-github-actions
#https://docs.github.com/en/rest/actions/cache?apiVersion=2022-11-28

run-name: GA DQGS ${{ github.event.head_commit.message }} ${{ github.sha }}

on:
  issues:
    types:
      - labeled
      - opened
  label:
    types:
      - created
  push:
    branches:
      - main
      - releases
  pull_request:
    # Sequence of patterns matched against refs/heads
    branches:
      - releases

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run
# in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production
# deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    environment:
      name: github-pages
    # At a minimum this job should upload artifacts using
    # actions/upload-pages-artifact
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # python-version: ["3.10", "3.11", "3.12", "3.13"]
        python-version: ["3.12"]
        node-version: ["16"]
    steps:
      - uses: actions/checkout@v3
        # https://github.com/actions/checkout
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Use node ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - uses: actions/cache@v3
        id: cache
        with:
          path: |
             ~/.cache/pip
          key: |
            ${{ runner.os }}-pip-${{ hashFiles('**/docs/requirements.*') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ hashFiles('**/docs/requirements.*') }}
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          sudo apt-get update -y --fix-missing || true
          sudo apt-get upgrade -y || true
          sudo apt-get install -y graphviz rhino lcov dia doxygen shellcheck
          sudo apt-get install -y build-essential zlib1g-dev libffi-dev 
          sudo apt-get install -y libbz2-dev libreadline-dev libsqlite3-dev  
          sudo apt install -y python3.12 python3.12-venv liblzma-dev
          sudo apt install -y libncurses-dev tk-dev libssl-dev

          echo "##### Gestion environnements virtuels #######"
          python3 -m venv envdev
          source envdev/bin/activate
          curl -fsSL https://pyenv.run | bash || true
          export PYENV_ROOT="$HOME/.pyenv"
          [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init - bash)"

          ### Installation hors reseau
          # mkdir -p ~/.pyenv/cache/ || true
          # curl -k --output-dir ~/.pyenv/cache/ -o Python-3.10.19.tar.xz https://www.python.org/ftp/python/3.10.19/Python-3.10.19.tar.xz
          # curl -k --output-dir ~/.pyenv/cache/ -o Python-3.11.14.tar.xz https://www.python.org/ftp/python/3.11.14/Python-3.11.14.tar.xz || true
          # curl -k --output-dir ~/.pyenv/cache/ -o Python-3.12.12.tar.xz https://www.python.org/ftp/python/3.12.12/Python-3.12.12.tar.xz
          
          pyenv install 3.10.19 || true
          pyenv install 3.11.14 || true
          pyenv install 3.12.12 || true
          
          pyenv global 3.10 3.11 3.12

          echo "######## dia installé = $(which dia) ########"
          python -m pip install --upgrade pip
          python -m pip install pylint-common --use-pep517
          if [ -f "./docs/requirements.txt" ]; then
            pip install -r "./docs/requirements.txt";
          fi
          # export PATH="$HOME/.local/bin":"${PATH}"
          echo "######## tox installé = $(which tox)"
          # export TZ="Europe/Paris"
          bash ./devtools/lanceur_mefversions.bash $GITHUB_SHA $GITHUB_RUN_ID || true

          echo "######## pwd ####"
          pwd
          bash ./devtools/lanceur_pytest.bash || true
          bash ./devtools/lanceur_pylint.bash || true
          bash ./devtools/lanceur_ruff.bash || true
          bash ./devtools/lanceur_sphinx.bash "github" || true
          bash ./devtools/lanceur_doxygen.bash || true
          bash ./devtools/lanceur_shellcheck.bash || true
          bash ./devtools/lanceur_tox.bash || true
          bash ./devtools/lanceur_build.bash || true
          echo "###### recherche dia"
          which dia

          echo "######### ls divers"
          
          ls -ail */*

          echo "####### mise en place des fichiers pour github-pages"

          mkdir -p docs/_build/html/doxygen || true
          mkdir -p docs/_build/html/htmlcov || true
          mkdir -p docs/_build/html/tox_cov_html || true
          
          mv rapports/doxygen docs/_build/html/ || true
          mv rapports/htmlcov docs/_build/html/ || true          
          mv rapports/tox_cov_html docs/_build/html/ || true
          mv build/sphinx-html docs/_build/html/ || true
          cp -fv docs/listem3u.png docs/_build/html/ || true
          cp -fv docs/index_github-pages.html docs/_build/html/index.html || true
          cp -fv rapports/coverage*.xml docs/_build/html/ || true
          cp -fv rapports/tox_cov.xml docs/_build/html/ || true
          cp -fv rapports/*.txt docs/_build/html/ || true
          echo "######### ls docs/_build/html/"
          ls -ail docs/_build/html/*

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          # Upload entire repository
          path: 'docs/_build/html'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Use node ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      #- name: SonarQube
      #  uses: SonarSource/sonarqube-scan-action@v6.0.0
      #  with:
      #    projectBaseDir: src
    
      #  env:
      #    name: github-pages
      #    SONAR_HOST_URL: ${{ secrets.SONAR_IO_HOST_URL }}
      #    SONAR_TOKEN: ${{ secrets.SONAR_IO_TOKEN_CI }}
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
        # If you wish to fail your job when the Quality Gate is red, uncomment the
        # following lines. This would typically be used to fail a deployment.
        # - uses: sonarsource/sonarqube-quality-gate-action@master
        #   timeout-minutes: 5 test 
        #   env:
        #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # - name: Run sonarqube
      #   run: sonar-scanner
      #         -Dsonar.sources=src
      #         -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
      #         -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  # https://docs.github.com/en/actions/security-guides/encrypted-secrets#using-encrypted-secrets-in-a-workflow
  # Sonarqube:
  #   environment:
  #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #       with:
  #         fetch-depth: 0
  #     - name: Use Node.js ${{ matrix.node-version }}
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: ${{ matrix.node-version }}
  #     - uses: sonarsource/sonarqube-scan-action@master

  # # Single deploy job since we're just deploying
  # publication:
  #   #echo "La vie est un court exil." | openssl enc -base64
  #   #TGEgdmllIGVzdCB1biBjb3VydCBleGlsLgo=
  #   #echo "TGEgdmllIGVzdCB1biBjb3VydCBleGlsLgo=" | openssl enc -base64 -d
  #   needs: build
  #   # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
  #   permissions:
  #     pages: write      # to deploy to Pages
  #     id-token: write   # to verify the deployment originates from
  #                       # an appropriate source
  #   environment:
  #     name: github-pages
  #     url: ${{ steps.deployment.outputs.page_url }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3
  #     - name: Setup Pages
  #       uses: actions/configure-pages@v3
  #     - name: Upload artifact
  #       uses: actions/upload-pages-artifact@v1
  #       with:
  #         # Upload entire repository
  #         path: './docs/_build/html'
  #     - name: Deploy to GitHub Pages
  #       id: deployment
  #       uses: actions/deploy-pages@v2

  #deploy:
    # Add a dependency to the build job
    #needs: build
    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    #permissions:
      #pages: write      # to deploy to Pages
      #id-token: write   # to verify the deployment originates from
                        # an appropriate source
    # Deploy to the github-pages environment
    #environment:
      #name: github-pages
      #url: ${{ steps.deployment.outputs.page_url }}

    # Specify runner + deployment step
    #runs-on: ubuntu-latest
    #steps:
      #- name: Deploy to GitHub Pages
        #id: deployment
        #uses: actions/deploy-pages@v1
